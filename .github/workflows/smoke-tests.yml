name: Smoke tests (mock OpenAI)

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  smoke:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      NODE_OPTIONS: --max_old_space_size=512

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install deps
        run: npm ci

      - name: Start server (mock mode)
        env:
          MOCK_OPENAI: "true"
          ALLOWED_TOKEN: ${{ secrets.ALLOWED_TOKEN }}
        run: |
          nohup node server.js > server.log 2>&1 &
          # wait for server to be up
          for i in {1..15}; do
            if curl -sS http://localhost:3000/ >/dev/null 2>&1; then
              echo "server up"
              break
            fi
            sleep 1
          done
          tail -n +1 server.log | sed -n '1,200p' || true

      - name: Run smoke curl tests
        env:
          TOKEN: ${{ secrets.ALLOWED_TOKEN }}
        run: |
          set -e
          # 1. token in body
          curl -sS -X POST "http://localhost:3000/generate" -H "Content-Type: application/json" -d "{\"token\":\"$TOKEN\",\"brief\":\"Smoke test brief\"}" | jq '.' >/dev/null
          echo "body token OK"

          # 2. X-Widget-Token header
          curl -sS -X POST "http://localhost:3000/generate" -H "Content-Type: application/json" -H "X-Widget-Token: $TOKEN" -d '{"brief":"Smoke test"}' | jq '.' >/dev/null
          echo "header token OK"

          # 3. Authorization Bearer
          curl -sS -X POST "http://localhost:3000/generate" -H "Content-Type: application/json" -H "Authorization: Bearer $TOKEN" -d '{"brief":"Smoke test"}' | jq '.' >/dev/null
          echo "bearer token OK"

          # 4. export (after generate with known session)
          curl -sS -X POST "http://localhost:3000/generate" -H "Content-Type: application/json" -d "{\"token\":\"$TOKEN\",\"brief\":\"Smoke test brief\",\"sessionId\":\"smoke-session-1\"}" | jq '.' >/dev/null
          curl -sS "http://localhost:3000/export?sessionId=smoke-session-1&token=$TOKEN" -o /tmp/landing.zip
          unzip -l /tmp/landing.zip >/dev/null
          echo "export OK"
