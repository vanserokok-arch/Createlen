# Render deployment configuration for Createlen
# This file defines both the web service and the worker for autonomous landing generation

services:
  # Main web service
  - type: web
    name: createlen-web
    runtime: node
    region: oregon
    plan: starter
    branch: copilot/add-openai-scaffold
    buildCommand: npm ci
    startCommand: node server.js
    healthCheckPath: /health
    envVars:
      - key: NODE_ENV
        value: production
      # OpenAI Configuration (supports both OPENAI_KEY and OPENAI_API_KEY)
      - key: OPENAI_KEY
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      # Authentication
      - key: ALLOWED_TOKEN
        generateValue: true
      # Database
      - key: DATABASE_URL
        fromDatabase:
          name: createlen-db
          property: connectionString
      # Redis Queue
      - key: REDIS_URL
        sync: false  # Set this to your Upstash Redis URL
      # S3 Configuration
      - key: S3_BUCKET
        sync: false
      - key: S3_ACCESS_KEY_ID
        sync: false
      - key: S3_SECRET_ACCESS_KEY
        sync: false
      - key: S3_REGION
        value: us-east-1
      # Render API (for monitoring)
      - key: RENDER_API_KEY
        sync: false
      - key: RENDER_SERVICE_ID
        sync: false
      # Port
      - key: PORT
        value: 3000
    autoDeploy: true

  # Background worker for async job processing
  - type: worker
    name: createlen-worker
    runtime: node
    region: oregon
    plan: starter
    branch: copilot/add-openai-scaffold
    buildCommand: npm ci
    startCommand: node worker/worker.js
    envVars:
      - key: NODE_ENV
        value: production
      # OpenAI Configuration
      - key: OPENAI_KEY
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      # Database
      - key: DATABASE_URL
        fromDatabase:
          name: createlen-db
          property: connectionString
      # Redis Queue
      - key: REDIS_URL
        sync: false
      # S3 Configuration
      - key: S3_BUCKET
        sync: false
      - key: S3_ACCESS_KEY_ID
        sync: false
      - key: S3_SECRET_ACCESS_KEY
        sync: false
      - key: S3_REGION
        value: us-east-1
      # Worker Configuration
      - key: WORKER_CONCURRENCY
        value: 2
    autoDeploy: true

# Database
databases:
  - name: createlen-db
    databaseName: createlen
    plan: starter
    region: oregon

# Notes:
# - Set OPENAI_KEY or OPENAI_API_KEY to your OpenAI API key
# - Set REDIS_URL to your Upstash Redis URL (rediss://...)
# - Configure S3_BUCKET, S3_ACCESS_KEY_ID, S3_SECRET_ACCESS_KEY for AWS S3
# - Or use Supabase Storage instead of S3 (requires code changes)
# - Run migrations manually after first deploy: psql $DATABASE_URL < scripts/migrate.sql
# - ALLOWED_TOKEN is auto-generated by Render
