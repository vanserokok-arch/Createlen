# Deploying Createlen to Render

This guide covers deploying the Createlen autonomous landing generation system to Render with PostgreSQL, Redis queue, and S3 storage.

## Prerequisites

1. **Render account**: Sign up at [render.com](https://render.com)
2. **Upstash Redis**: Create a Redis database at [upstash.com](https://upstash.com) (free tier available)
3. **AWS S3 bucket** OR **Supabase Storage**:
   - AWS S3: Create a bucket and IAM user with S3 access
   - Supabase: Sign up at [supabase.com](https://supabase.com) and create a project
4. **OpenAI API key**: Get from [platform.openai.com](https://platform.openai.com)

## Environment Variables

Configure these environment variables in Render Dashboard:

### Required Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `OPENAI_KEY` | OpenAI API key (primary) | `sk-...` |
| `OPENAI_API_KEY` | OpenAI API key (fallback) | `sk-...` |
| `ALLOWED_TOKEN` | API authentication token | Auto-generated by Render |
| `DATABASE_URL` | PostgreSQL connection string | Auto-set by Render |
| `REDIS_URL` | Upstash Redis URL | `rediss://default:...@...upstash.io:6379` |
| `S3_BUCKET` | S3 bucket name | `createlen-artifacts` |
| `S3_ACCESS_KEY_ID` | AWS access key ID | `AKIA...` |
| `S3_SECRET_ACCESS_KEY` | AWS secret access key | `...` |
| `S3_REGION` | AWS region | `us-east-1` |

### Optional Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `WORKER_CONCURRENCY` | Number of concurrent jobs | `2` |
| `RENDER_API_KEY` | Render API key (for monitoring) | - |
| `RENDER_SERVICE_ID` | Render service ID | - |
| `PORT` | Web service port | `3000` |

## Deployment Steps

### 1. Connect Repository

1. Go to [Render Dashboard](https://dashboard.render.com)
2. Click **New** → **Blueprint**
3. Connect your GitHub repository
4. Select the `copilot/add-openai-scaffold` branch
5. Render will automatically detect `render.yaml`

### 2. Configure Environment Variables

1. Go to each service (web and worker) in Render Dashboard
2. Navigate to **Environment** tab
3. Add the required environment variables listed above
4. Save changes

### 3. Set up Upstash Redis

1. Go to [console.upstash.com](https://console.upstash.com)
2. Create a new Redis database (choose free tier)
3. Copy the `UPSTASH_REDIS_REST_URL` or connection string
4. Set it as `REDIS_URL` in Render

### 4. Set up S3 Storage

#### Option A: AWS S3

1. Create an S3 bucket in AWS Console
2. Create an IAM user with S3 access
3. Attach policy:
   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Effect": "Allow",
         "Action": [
           "s3:PutObject",
           "s3:GetObject",
           "s3:DeleteObject"
         ],
         "Resource": "arn:aws:s3:::YOUR-BUCKET-NAME/*"
       }
     ]
   }
   ```
4. Generate access keys
5. Set environment variables in Render

#### Option B: Supabase Storage (Alternative)

If using Supabase Storage instead of S3, you'll need to modify `server/s3.js` to use Supabase SDK.

### 5. Run Database Migrations

After the first deployment:

1. Go to **createlen-web** service in Render
2. Click **Shell** tab (or use Render API)
3. Run migration:
   ```bash
   psql $DATABASE_URL < scripts/migrate.sql
   ```

Alternatively, connect to the database from your local machine:
```bash
psql "postgresql://..." -f scripts/migrate.sql
```

### 6. Deploy

1. Render will automatically deploy when you push to the configured branch
2. Monitor deployment logs in Render Dashboard
3. Check health endpoint: `https://your-service.onrender.com/health`

## Build and Start Commands

### Web Service
- **Build Command**: `npm ci`
- **Start Command**: `node server.js`

### Worker Service
- **Build Command**: `npm ci`
- **Start Command**: `node worker/worker.js`

## Health Check

The web service exposes a `/health` endpoint that checks:
- Service status
- Database connection
- OpenAI API key configuration

Configure Render health check:
- **Path**: `/health`
- **Expected Status**: `200`

## Testing the Deployment

### Synchronous Generation (immediate response)
```bash
curl -X POST https://your-service.onrender.com/generate \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ALLOWED_TOKEN" \
  -d '{
    "brief": "Создать сайт для юридической компании по банкротству",
    "page_type": "invest",
    "sessionId": "test-session-1"
  }'
```

### Asynchronous Generation (queued)
```bash
# Submit job
curl -X POST https://your-service.onrender.com/generate \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ALLOWED_TOKEN" \
  -d '{
    "brief": "Создать сайт для юридической компании по банкротству",
    "page_type": "invest",
    "sessionId": "test-session-2",
    "async": true
  }'

# Check status
curl -X GET "https://your-service.onrender.com/status?sessionId=test-session-2&token=YOUR_ALLOWED_TOKEN"
```

## Monitoring

### Logs
- View logs in Render Dashboard for each service
- Web service logs show API requests
- Worker logs show job processing

### Metrics
- Monitor queue length in Upstash dashboard
- Check database size in Render dashboard
- S3 storage usage in AWS Console

### Alerts
Set up alerts in Render for:
- Service crashes
- High memory usage
- Failed health checks

## Troubleshooting

### Common Issues

**Database connection errors**
- Check `DATABASE_URL` is set correctly
- Ensure migrations have been run
- Verify database is running in Render

**Redis connection errors**
- Verify `REDIS_URL` format is correct (should start with `rediss://` for TLS)
- Check Upstash dashboard for connection limits
- Ensure Redis database is active

**S3 upload errors**
- Verify S3 credentials are correct
- Check IAM user has proper permissions
- Ensure bucket exists and region matches
- Check bucket CORS settings if accessing from browser

**OpenAI API errors**
- Verify API key is valid
- Check API key has sufficient credits
- Ensure rate limits are not exceeded
- Use `OPENAI_KEY` or `OPENAI_API_KEY` (both supported)

**Worker not processing jobs**
- Check worker service is running in Render
- View worker logs for errors
- Verify Redis connection is working
- Check OpenAI API key is set in worker environment

## Scaling

### Web Service
- Upgrade Render plan for more resources
- Add horizontal scaling (multiple instances)
- Configure auto-scaling based on traffic

### Worker Service
- Increase `WORKER_CONCURRENCY` environment variable
- Upgrade to larger Render plan
- Deploy multiple worker instances

### Database
- Upgrade to larger PostgreSQL plan in Render
- Consider connection pooling for high traffic
- Add read replicas if needed

## Security Best Practices

1. **Never commit secrets** to the repository
2. **Use environment variables** for all sensitive data
3. **Rotate API keys** regularly
4. **Enable HTTPS** (automatic on Render)
5. **Use strong `ALLOWED_TOKEN`** (Render generates secure tokens)
6. **Restrict S3 bucket access** to specific IAM user
7. **Enable Redis authentication** (Upstash includes by default)
8. **Monitor API usage** to detect abuse

## Cost Estimates

### Free Tier
- Render: Free web service (spins down after inactivity) + $7/month worker
- Upstash: Free tier (10,000 commands/day)
- Supabase: Free tier (500MB storage)
- AWS S3: ~$0.023/GB + request costs

### Paid Tier (low traffic)
- Render: $7/month web + $7/month worker = $14/month
- Upstash: Free tier sufficient
- Database: $7/month (Render Starter)
- S3: ~$1-5/month depending on usage
- **Total**: ~$22-26/month

## Next Steps

- Set up monitoring and alerting
- Configure backup strategy for database
- Implement rate limiting for API endpoints
- Add more robust error handling
- Set up CI/CD pipeline for automated deployments
- Add integration tests for deployment validation
